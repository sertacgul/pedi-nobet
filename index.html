<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MediNöbet - Nöbet Asistanı</title>
<!-- iOS PWA Ayarları -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MediNöbet">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">
<!-- Kütüphaneler -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<style>

        body { font-family: 'Varela Round', sans-serif; background-color: #f0f9ff; -webkit-tap-highlight-color: transparent; }

        .glass-card { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(255, 255, 255, 0.5); }

        .tab-active { color: #2563eb; border-bottom: 3px solid #2563eb; }

        .tab-inactive { color: #94a3b8; }

        /* Takvim Hücresi */

        .cal-day { 

            min-height: 90px; 

            display: flex; 

            flex-direction: column; 

            align-items: start; 

            justify-content: start; 

            padding: 4px; 

            cursor: pointer; 

            border-radius: 8px; 

            transition: all 0.2s; 

            position: relative; 

            border: 1px solid transparent; 

            overflow: hidden;

        }

        .cal-day:active { transform: scale(0.98); }

        /* İsim Listesi Scroll Gizleme */

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Durum Renkleri */

        .status-ok { background-color: #dcfce7; color: #166534; border-color: #86efac; }

        .status-error { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; }

        .status-neutral { background-color: #ffffff; color: #475569; border-color: #e2e8f0; }

        /* Tercih Renkleri */

        .pref-wanted { background-color: #4ade80 !important; color: white !important; }

        .pref-blocked { background-color: #f87171 !important; color: white !important; }

        /* Modal Animasyon */

        .modal { transition: opacity 0.25s ease; }

        body.modal-active { overflow: hidden; }
</style>
</head>
<body class="text-slate-700 h-screen flex flex-col">
<!-- Üst Bar -->
<header class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-20 pt-safe-top">
<div class="flex justify-between items-center max-w-3xl mx-auto">
<div class="flex items-center gap-3">
<i class="fa-solid fa-hospital-user text-3xl"></i>
<div>
<h1 class="text-xl font-bold leading-tight">MediNöbet</h1>
<p class="text-[10px] text-blue-200 opacity-90 font-light tracking-wide">Generated by ATAOL AI Techs</p>
</div>
</div>
<button onclick="downloadReport()" class="bg-green-500 hover:bg-green-600 px-3 py-1.5 rounded text-xs font-bold shadow transition flex items-center">
<i class="fa-solid fa-file-excel mr-1"></i> Rapor
</button>
</div>
</header>
<!-- Tab Menü -->
<nav class="bg-white shadow-sm z-10">
<div class="flex max-w-3xl mx-auto">
<button onclick="switchTab('calendar')" id="tab-calendar" class="flex-1 py-3 text-center font-bold text-sm tab-active transition">
<i class="fa-regular fa-calendar-days mb-1 block"></i> Takvim
</button>
<button onclick="switchTab('doctors')" id="tab-doctors" class="flex-1 py-3 text-center font-bold text-sm tab-inactive transition">
<i class="fa-solid fa-user-doctor mb-1 block"></i> Doktorlar
</button>
<button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-3 text-center font-bold text-sm tab-inactive transition">
<i class="fa-solid fa-sliders mb-1 block"></i> Ayarlar
</button>
</div>
</nav>
<!-- Ana İçerik Alanı -->
<main class="flex-1 overflow-y-auto p-4 max-w-3xl mx-auto w-full relative">
<!-- 1. TAKVİM GÖRÜNÜMÜ -->
<div id="view-calendar" class="space-y-4">
<!-- Ay Seçimi -->
<div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm">
<button onclick="changeMonth(-1)" class="p-2 text-blue-600"><i class="fa-solid fa-chevron-left"></i></button>
<h2 id="currentMonthLabel" class="text-lg font-bold text-slate-800">Ekim 2023</h2>
<button onclick="changeMonth(1)" class="p-2 text-blue-600"><i class="fa-solid fa-chevron-right"></i></button>
</div>
<!-- Takvim Grid -->
<div class="bg-white p-3 rounded-xl shadow-sm">
<!-- Gün İsimleri -->
<div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-600 mb-2 border-b pb-2">
<div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div>Paz</div>
</div>
<div id="calendarGrid" class="grid grid-cols-7 gap-2">
<!-- Günler JS ile dolacak -->
</div>
</div>
<div class="text-xs text-center text-slate-400 mt-2">
<span class="inline-block w-3 h-3 bg-red-100 border border-red-300 rounded mr-1 align-middle"></span> Eksik/Hata
<span class="inline-block w-3 h-3 bg-green-100 border border-green-300 rounded ml-2 mr-1 align-middle"></span> Tamam
</div>
</div>
<!-- 2. DOKTOR YÖNETİMİ GÖRÜNÜMÜ -->
<div id="view-doctors" class="hidden space-y-4">
<div class="glass-card p-4 rounded-2xl shadow-sm border-l-4 border-blue-500">
<h3 class="font-bold text-blue-600 mb-2">Yeni Doktor Ekle / Düzenle</h3>
<input type="text" id="docNameInput" placeholder="Doktor Adı Soyadı (Örn: Feride GÜL)" class="w-full p-3 rounded-lg border border-slate-200 mb-3 focus:outline-blue-500">
<p class="text-xs text-slate-500 mb-2">Tercihler için aşağıdaki takvimi kullanın:<br>
<span class="text-green-600 font-bold">1 Tık: İstiyor (Yeşil)</span> | 
<span class="text-red-600 font-bold">2 Tık: İstemiyor (Kırmızı)</span> | 
<span class="text-slate-400">3 Tık: Nötr</span></p>
<!-- Mini Takvim (Tercih İçin) -->
<div class="bg-slate-50 p-2 rounded-lg border border-slate-200 mb-3">
<div class="flex justify-between mb-2 px-2">
<button onclick="changePrefMonth(-1)" class="text-xs"><i class="fa-solid fa-chevron-left"></i></button>
<span id="prefMonthLabel" class="text-xs font-bold">Ay</span>
<button onclick="changePrefMonth(1)" class="text-xs"><i class="fa-solid fa-chevron-right"></i></button>
</div>
<div id="prefGrid" class="grid grid-cols-7 gap-1"></div>
</div>
<button onclick="saveDoctor()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow hover:bg-blue-700 transition">
<i class="fa-solid fa-floppy-disk mr-2"></i> Doktoru Kaydet
</button>
</div>
<!-- Kayıtlı Doktorlar Listesi -->
<h3 class="font-bold text-slate-600">Kayıtlı Doktorlar</h3>
<ul id="doctorsList" class="space-y-2"></ul>
</div>
<!-- 3. AYARLAR GÖRÜNÜMÜ -->
<div id="view-settings" class="hidden space-y-4">
<div class="bg-white p-4 rounded-2xl shadow-sm">
<h3 class="font-bold text-slate-700 mb-4 flex items-center">
<i class="fa-solid fa-list-check mr-2 text-blue-500"></i> Nöbet Sahaları (8 Adet)
</h3>
<p class="text-xs text-slate-500 mb-3">Saha isimlerini ve gerekli kişi sayılarını belirleyin.</p>
<div id="slotsConfigList" class="space-y-3">
<!-- JS ile dolacak -->
</div>
<button onclick="saveSettings()" class="w-full mt-4 bg-slate-800 text-white font-bold py-3 rounded-xl shadow hover:bg-slate-900 transition">

                    Ayarları Güncelle
</button>
<div class="mt-8 pt-4 border-t border-slate-100">
<button onclick="clearAllSystem()" class="w-full bg-red-50 text-red-600 font-bold py-2 rounded-lg border border-red-100 text-sm">
<i class="fa-solid fa-triangle-exclamation mr-1"></i> Tüm Verileri Sıfırla
</button>
</div>
</div>
</div>
</main>
<!-- Footer -->
<footer class="bg-white border-t border-slate-200 p-6 text-center z-10">
<div class="max-w-md mx-auto">
<i class="fa-solid fa-star-and-crescent text-red-500 text-xl mb-2 block"></i>
<p class="text-slate-600 italic font-serif text-sm">"Beni Türk hekimlerine emanet edin."</p>
<p class="text-slate-800 font-bold text-xs mt-1 tracking-wide">Büyük ATATÜRK</p>
</div>
</footer>
<!-- NÖBET ATAMA MODALI -->
<div id="dayModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-end sm:items-center justify-center z-50">
<div class="modal-overlay absolute w-full h-full bg-black opacity-50" onclick="closeModal('dayModal')"></div>
<div class="modal-container bg-white w-full max-w-md mx-auto rounded-t-3xl sm:rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] flex flex-col">
<div class="bg-blue-600 p-4 text-white rounded-t-3xl sm:rounded-t-xl sticky top-0 z-10 flex justify-between items-center">
<div>
<h3 id="modalDateTitle" class="text-lg font-bold">Tarih</h3>
<p class="text-xs text-blue-100">Nöbetçi Atama Ekranı</p>
</div>
<button onclick="closeModal('dayModal')" class="text-white hover:bg-blue-700 p-2 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button>
</div>
<div class="p-4 space-y-4 flex-1">
<div id="modalWarnings" class="hidden bg-amber-50 border border-amber-200 text-amber-800 text-xs p-3 rounded-lg"></div>
<div id="modalSlotsArea" class="space-y-4"></div>
</div>
<div class="p-3 border-t bg-slate-50 sticky bottom-0">
<button onclick="closeModal('dayModal')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Tamam</button>
</div>
</div>
</div>
<!-- DOKTOR İSTATİSTİK MODALI -->
<div id="statsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-end sm:items-center justify-center z-50">
<div class="modal-overlay absolute w-full h-full bg-black opacity-50" onclick="closeModal('statsModal')"></div>
<div class="modal-container bg-white w-full max-w-md mx-auto rounded-t-3xl sm:rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col">
<div class="bg-slate-800 p-4 text-white rounded-t-3xl sm:rounded-t-xl flex justify-between items-center">
<h3 id="statsDocTitle" class="text-lg font-bold">İstatistikler</h3>
<button onclick="closeModal('statsModal')" class="text-white hover:bg-slate-700 p-2 rounded-full"><i class="fa-solid fa-xmark"></i></button>
</div>
<div id="statsContent" class="p-5 overflow-y-auto max-h-[80vh]"></div>
</div>
</div>
<script>

        // --- VERİ YAPISI ---

        let currentDate = new Date();

        let currentPrefDate = new Date();

        let settings = JSON.parse(localStorage.getItem('mediSettings')) || {

            slots: [

                { id: 1, name: "Servis", min: 1, max: 2 },

                { id: 2, name: "Acil 1", min: 1, max: 1 },

                { id: 3, name: "Acil 2", min: 1, max: 1 },

                { id: 4, name: "Konsültasyon", min: 1, max: 1 },

                { id: 5, name: "Yedek 1", min: 1, max: 1 },

                { id: 6, name: "Yedek 2", min: 0, max: 1 },

                { id: 7, name: "Saha 7", min: 0, max: 1 },

                { id: 8, name: "Saha 8", min: 0, max: 1 }

            ]

        };

        let doctors = JSON.parse(localStorage.getItem('mediDoctors')) || [];

        let assignments = JSON.parse(localStorage.getItem('mediAssignments')) || {};

        let editingDoc = { id: null, name: "", prefs: {} };

        // --- BAŞLANGIÇ ---

        document.addEventListener('DOMContentLoaded', () => {

            renderCalendar();

            renderSettings();

            renderDoctorsList();

            renderPrefCalendar();

        });

        // --- TAB YÖNETİMİ ---

        function switchTab(tabName) {

            document.getElementById('view-calendar').classList.add('hidden');

            document.getElementById('view-doctors').classList.add('hidden');

            document.getElementById('view-settings').classList.add('hidden');

            ['calendar', 'doctors', 'settings'].forEach(t => {

                const btn = document.getElementById(`tab-${t}`);

                if(t === tabName) {

                    btn.classList.remove('tab-inactive');

                    btn.classList.add('tab-active');

                    document.getElementById(`view-${t}`).classList.remove('hidden');

                } else {

                    btn.classList.remove('tab-active');

                    btn.classList.add('tab-inactive');

                }

            });

            if(tabName === 'calendar') renderCalendar();

            if(tabName === 'doctors') {

                editingDoc = { id: null, name: "", prefs: {} };

                document.getElementById('docNameInput').value = "";

                renderPrefCalendar();

            }

        }

        // --- TAKVİM MANTIĞI ---

        function changeMonth(dir) {

            currentDate.setMonth(currentDate.getMonth() + dir);

            renderCalendar();

        }

        function renderCalendar() {

            const grid = document.getElementById('calendarGrid');

            const lbl = document.getElementById('currentMonthLabel');

            grid.innerHTML = '';

            const year = currentDate.getFullYear();

            const month = currentDate.getMonth();

            lbl.textContent = new Date(year, month).toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay(); // 0: Pazar

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let startOffset = firstDay === 0 ? 6 : firstDay - 1;

            // Boşluklar

            for(let i=0; i<startOffset; i++) {

                grid.innerHTML += `<div></div>`;

            }

            // Günler

            for(let d=1; d<=daysInMonth; d++) {

                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                const dateObj = new Date(year, month, d);

                const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'short' }); 

                const status = validateDayStatus(dateStr);

                let statusClass = 'status-neutral';

                if(status === 'error') statusClass = 'status-error';

                else if(status === 'ok') statusClass = 'status-ok';

                // --- İSİMLERİ HAZIRLA ---

                let assignedNames = [];

                if(assignments[dateStr]) {

                    Object.values(assignments[dateStr]).forEach(docs => {

                        if(Array.isArray(docs)) assignedNames.push(...docs);

                    });

                }

                let namesHtml = '';

                if(assignedNames.length > 0) {

                    namesHtml = `<div class="w-full mt-1 flex flex-col gap-0.5 overflow-y-auto no-scrollbar" style="max-height: 100%;">`;

                    // Duplicate isimleri önle ve her ismin yanına silme butonu ekle

                    [...new Set(assignedNames)].forEach(name => {

                        namesHtml += `
<div class="flex items-center justify-between bg-white/60 px-1 rounded gap-1">
<span class="text-[9px] leading-3 text-slate-700 truncate">${name}</span>
<button onclick="deleteAssignment(event, '${dateStr}', '${name}')" class="text-red-500 hover:text-red-700 text-[10px] leading-none flex items-center justify-center w-3 h-3 rounded-full hover:bg-red-100 transition-colors">
<i class="fa-solid fa-times"></i>
</button>
</div>`;

                    });

                    namesHtml += `</div>`;

                }

                const dayDiv = document.createElement('div');

                dayDiv.className = `cal-day ${statusClass}`;

                dayDiv.innerHTML = `
<div class="flex justify-between w-full items-baseline border-b border-black/5 pb-0.5 mb-0.5 shrink-0">
<span class="font-bold text-sm leading-none">${d}</span>
<span class="text-[9px] opacity-70 leading-none">${dayName}</span>
</div>

                    ${namesHtml}

                `;

                if(status === 'error') {

                     dayDiv.innerHTML += `<span class="absolute top-1 right-1 w-1.5 h-1.5 bg-red-500 rounded-full"></span>`;

                }

                dayDiv.onclick = () => openDayModal(dateStr);

                grid.appendChild(dayDiv);

            }

        }

        // --- TAKVİMDEN DOĞRUDAN SİLME ---

        function deleteAssignment(e, dateStr, docName) {

            e.stopPropagation(); 

            if(!confirm(`${docName} adlı doktoru ${dateStr} tarihli nöbetten silmek istediğinize emin misiniz?`)) return;

            if (assignments[dateStr]) {

                let changed = false;

                Object.keys(assignments[dateStr]).forEach(slotKey => {

                    if (assignments[dateStr][slotKey].includes(docName)) {

                        assignments[dateStr][slotKey] = assignments[dateStr][slotKey].filter(n => n !== docName);

                        changed = true;

                    }

                });

                if (changed) {

                    localStorage.setItem('mediAssignments', JSON.stringify(assignments));

                    renderCalendar(); 

                }

            }

        }

        function validateDayStatus(dateStr) {

            if(!assignments[dateStr]) return 'neutral'; 

            let dayAssigns = assignments[dateStr];

            let isOk = true;

            let hasAny = false;

            settings.slots.forEach(slot => {

                const assignedCount = (dayAssigns[`slot${slot.id}`] || []).length;

                if(assignedCount > 0) hasAny = true;

                if(assignedCount < slot.min || assignedCount > slot.max) isOk = false;

            });

            if(!hasAny) return 'neutral';

            return isOk ? 'ok' : 'error';

        }

        // --- MODAL VE ATAMA İŞLEMLERİ ---

        let selectedDateStr = "";

        function openDayModal(dateStr) {

            selectedDateStr = dateStr;

            const dateObj = new Date(dateStr);

            document.getElementById('modalDateTitle').textContent = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });

            document.getElementById('dayModal').classList.remove('opacity-0', 'pointer-events-none');

            document.body.classList.add('modal-active');

            renderModalSlots();

        }

        function closeModal(modalId) {

            document.getElementById(modalId).classList.add('opacity-0', 'pointer-events-none');

            document.body.classList.remove('modal-active');

            if(modalId === 'dayModal') renderCalendar();

        }

        function renderModalSlots() {

            const container = document.getElementById('modalSlotsArea');

            container.innerHTML = '';

            let dayAssigns = assignments[selectedDateStr] || {};

            let warnings = [];

            // --- AKILLI SIRALAMA ---

            let sortedDoctors = [...doctors].sort((a, b) => {

                const prefA = a.prefs[selectedDateStr] || 0;

                const prefB = b.prefs[selectedDateStr] || 0;

                const getWeight = (p) => p === 1 ? 0 : (p === 0 ? 1 : 2);

                return getWeight(prefA) - getWeight(prefB);

            });

            settings.slots.forEach(slot => {

                const currentDocs = dayAssigns[`slot${slot.id}`] || [];

                const slotDiv = document.createElement('div');

                slotDiv.className = "border rounded-xl p-3 bg-slate-50";

                let countColor = "text-slate-500";

                if(currentDocs.length < slot.min) { countColor = "text-red-600 font-bold"; warnings.push(`${slot.name}: Eksik doktor.`); }

                else if(currentDocs.length > slot.max) { countColor = "text-red-600 font-bold"; warnings.push(`${slot.name}: Fazla doktor.`); }

                else if(currentDocs.length > 0) { countColor = "text-green-600 font-bold"; }

                slotDiv.innerHTML = `
<div class="flex justify-between items-center mb-2">
<span class="font-bold text-sm">${slot.name}</span>
<span class="text-xs ${countColor}">(${currentDocs.length} / ${slot.min}-${slot.max})</span>
</div>

                `;

                const buttonsDiv = document.createElement('div');

                buttonsDiv.className = "flex flex-wrap gap-2";

                sortedDoctors.forEach(doc => {

                    const isAssignedHere = currentDocs.includes(doc.name);

                    const pref = doc.prefs[selectedDateStr] || 0; 

                    let btnClass = "px-3 py-1.5 rounded text-xs border transition flex items-center gap-1 ";

                    let icon = "";

                    if(isAssignedHere) {

                        btnClass += "bg-blue-600 text-white border-blue-600 shadow-md";

                        icon = `<i class="fa-solid fa-check"></i>`;

                    } else {

                        btnClass += "bg-white text-slate-600 border-slate-200 hover:bg-slate-100";

                    }

                    if(pref === 1) icon += `<i class="fa-solid fa-star text-green-500 ml-1"></i>`;

                    if(pref === 2) icon += `<i class="fa-solid fa-ban text-red-400 ml-1"></i>`;

                    const btn = document.createElement('button');

                    btn.className = btnClass;

                    btn.innerHTML = `${icon} ${doc.name}`;

                    btn.onclick = () => toggleAssignment(slot.id, doc.name);

                    buttonsDiv.appendChild(btn);

                });

                slotDiv.appendChild(buttonsDiv);

                container.appendChild(slotDiv);

            });

            const warnBox = document.getElementById('modalWarnings');

            if(warnings.length > 0) {

                warnBox.classList.remove('hidden');

                warnBox.innerHTML = `<strong>Dikkat:</strong><ul class="list-disc list-inside mt-1">${warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;

            } else {

                warnBox.classList.add('hidden');

            }

        }

        function toggleAssignment(slotId, docName) {

            if(!assignments[selectedDateStr]) assignments[selectedDateStr] = {};

            let slotKey = `slot${slotId}`;

            let current = assignments[selectedDateStr][slotKey] || [];

            if(current.includes(docName)) {

                current = current.filter(n => n !== docName);

            } else {

                settings.slots.forEach(s => {

                    let k = `slot${s.id}`;

                    if(assignments[selectedDateStr][k] && assignments[selectedDateStr][k].includes(docName)) {

                        assignments[selectedDateStr][k] = assignments[selectedDateStr][k].filter(n => n !== docName);

                    }

                });

                current.push(docName);

            }

            assignments[selectedDateStr][slotKey] = current;

            localStorage.setItem('mediAssignments', JSON.stringify(assignments));

            renderModalSlots();

        }

        // --- DOKTOR YÖNETİMİ ---

        function changePrefMonth(dir) {

            currentPrefDate.setMonth(currentPrefDate.getMonth() + dir);

            renderPrefCalendar();

        }

        function renderPrefCalendar() {

            const grid = document.getElementById('prefGrid');

            const lbl = document.getElementById('prefMonthLabel');

            grid.innerHTML = '';

            const year = currentPrefDate.getFullYear();

            const month = currentPrefDate.getMonth();

            lbl.textContent = new Date(year, month).toLocaleDateString('tr-TR', { month: 'short', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let startOffset = firstDay === 0 ? 6 : firstDay - 1;

            for(let i=0; i<startOffset; i++) grid.innerHTML += `<div></div>`;

            for(let d=1; d<=daysInMonth; d++) {

                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                const pref = editingDoc.prefs[dateStr] || 0;

                const dayDiv = document.createElement('div');

                let colorClass = "bg-white text-slate-600 border border-slate-100";

                if(pref === 1) colorClass = "pref-wanted";

                if(pref === 2) colorClass = "pref-blocked";

                dayDiv.className = `h-8 flex items-center justify-center rounded cursor-pointer text-xs font-bold ${colorClass}`;

                dayDiv.textContent = d;

                dayDiv.onclick = () => {

                    let next = (pref + 1) % 3;

                    if(next === 0) delete editingDoc.prefs[dateStr];

                    else editingDoc.prefs[dateStr] = next;

                    renderPrefCalendar();

                };

                grid.appendChild(dayDiv);

            }

        }

        function saveDoctor() {

            const nameInput = document.getElementById('docNameInput');

            const name = nameInput.value.trim(); 

            if(!name) { alert('Lütfen isim giriniz.'); return; }

            const formattedName = name; 

            if(editingDoc.id) {

                const idx = doctors.findIndex(d => d.id === editingDoc.id);

                doctors[idx] = { ...editingDoc, name: formattedName };

            } else {

                doctors.push({ id: Date.now(), name: formattedName, prefs: editingDoc.prefs });

            }

            localStorage.setItem('mediDoctors', JSON.stringify(doctors));

            document.getElementById('docNameInput').value = "";

            editingDoc = { id: null, name: "", prefs: {} };

            renderPrefCalendar();

            renderDoctorsList();

            alert('Doktor kaydedildi!');

        }

        function editDoctor(id) {

            const doc = doctors.find(d => d.id === id);

            if(doc) {

                editingDoc = JSON.parse(JSON.stringify(doc));

                document.getElementById('docNameInput').value = doc.name;

                renderPrefCalendar();

                document.querySelector('main').scrollTop = 0;

            }

        }

        function deleteDoctor(id) {

            if(confirm('Doktor silinecek?')) {

                doctors = doctors.filter(d => d.id !== id);

                localStorage.setItem('mediDoctors', JSON.stringify(doctors));

                renderDoctorsList();

            }

        }

        // --- DOKTOR İSTATİSTİKLERİ ---

        function showDoctorStats(docName) {

            document.getElementById('statsDocTitle').textContent = `${docName} - Nöbet Analizi`;

            let stats = {

                total: 0,

                weekdays: 0, 

                friday: 0,

                saturday: 0,

                sunday: 0,

                slots: {}

            };

            settings.slots.forEach(s => stats.slots[s.name] = 0);

            Object.keys(assignments).forEach(dateStr => {

                let workedToday = false;

                settings.slots.forEach(s => {

                    if(assignments[dateStr][`slot${s.id}`]?.includes(docName)) {

                        stats.slots[s.name]++;

                        workedToday = true;

                    }

                });

                if(workedToday) {

                    stats.total++;

                    const d = new Date(dateStr);

                    const day = d.getDay(); 

                    if(day === 5) stats.friday++;

                    else if(day === 6) stats.saturday++;

                    else if(day === 0) stats.sunday++;

                    else stats.weekdays++;

                }

            });

            let html = `
<div class="grid grid-cols-2 gap-3 mb-4">
<div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-center">
<div class="text-2xl font-bold text-blue-600">${stats.total}</div>
<div class="text-xs text-blue-400 font-bold uppercase">Toplam Nöbet</div>
</div>
<div class="space-y-1">
<div class="flex justify-between text-xs p-1 bg-slate-50 rounded border"><span>Haftaiçi (Pzt-Per):</span> <span class="font-bold">${stats.weekdays}</span></div>
<div class="flex justify-between text-xs p-1 bg-purple-50 rounded border border-purple-100 text-purple-700"><span>Cuma:</span> <span class="font-bold">${stats.friday}</span></div>
<div class="flex justify-between text-xs p-1 bg-orange-50 rounded border border-orange-100 text-orange-700"><span>Cumartesi:</span> <span class="font-bold">${stats.saturday}</span></div>
<div class="flex justify-between text-xs p-1 bg-red-50 rounded border border-red-100 text-red-700"><span>Pazar:</span> <span class="font-bold">${stats.sunday}</span></div>
</div>
</div>
<h4 class="font-bold text-sm text-slate-700 mb-2 border-b pb-1">Saha Dağılımı</h4>
<div class="grid grid-cols-2 gap-2 text-xs">

            `;

            Object.entries(stats.slots).forEach(([slotName, count]) => {

                html += `
<div class="flex justify-between items-center bg-white p-2 rounded border border-slate-100">
<span class="text-slate-500">${slotName}</span>
<span class="font-bold bg-slate-100 px-2 py-0.5 rounded-full text-slate-700">${count}</span>
</div>

                `;

            });

            html += `</div>`;

            document.getElementById('statsContent').innerHTML = html;

            document.getElementById('statsModal').classList.remove('opacity-0', 'pointer-events-none');

            document.body.classList.add('modal-active');

        }

        function renderDoctorsList() {

            const list = document.getElementById('doctorsList');

            list.innerHTML = '';

            doctors.forEach(doc => {

                const li = document.createElement('li');

                li.className = "flex justify-between items-center bg-white p-3 rounded-xl shadow-sm";

                li.innerHTML = `
<div class="flex items-center gap-2 cursor-pointer hover:opacity-70" onclick="showDoctorStats('${doc.name}')">
<div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs">
<i class="fa-solid fa-chart-pie"></i>
</div>
<span class="font-bold text-slate-700">${doc.name}</span>
</div>
<div class="flex gap-2">
<button onclick="editDoctor(${doc.id})" class="text-blue-500 bg-blue-50 p-2 rounded-lg"><i class="fa-solid fa-pen"></i></button>
<button onclick="deleteDoctor(${doc.id})" class="text-red-500 bg-red-50 p-2 rounded-lg"><i class="fa-solid fa-trash"></i></button>
</div>

                `;

                list.appendChild(li);

            });

        }

        function renderSettings() {

            const list = document.getElementById('slotsConfigList');

            list.innerHTML = '';

            settings.slots.forEach((slot, index) => {

                const div = document.createElement('div');

                div.className = "flex gap-2 items-center text-sm";

                div.innerHTML = `
<span class="font-bold text-slate-400 w-4">${slot.id}.</span>
<input type="text" value="${slot.name}" onchange="updateSlot(${index}, 'name', this.value)" class="flex-1 border rounded p-2" placeholder="Saha Adı">
<input type="number" value="${slot.min}" onchange="updateSlot(${index}, 'min', this.value)" class="w-16 border rounded p-2 text-center" placeholder="Min">
<input type="number" value="${slot.max}" onchange="updateSlot(${index}, 'max', this.value)" class="w-16 border rounded p-2 text-center" placeholder="Max">

                `;

                list.appendChild(div);

            });

        }

        function updateSlot(index, field, value) {

            if(field !== 'name') value = parseInt(value);

            settings.slots[index][field] = value;

        }

        function saveSettings() {

            localStorage.setItem('mediSettings', JSON.stringify(settings));

            alert('Ayarlar kaydedildi.');

            renderCalendar(); 

        }

        function clearAllSystem() {

            if(confirm('TÜM DOKTORLAR VE NÖBETLER SİLİNECEK! Emin misiniz?')) {

                localStorage.removeItem('mediAssignments');

                localStorage.removeItem('mediDoctors');

                location.reload();

            }

        }

        // --- RAPORLAMA ---

        function downloadReport() {

            let csvContent = "\uFEFF"; 

            let headers = ["İSİM"];

            settings.slots.forEach(s => headers.push(s.name.toUpperCase()));

            headers.push("TOPLAM", "HAFTAİÇİ", "CUMA", "CUMARTESİ", "PAZAR");

            csvContent += headers.join(";") + "\n";

            // Türkçe isme göre sıralama

            const sortedDocs = [...doctors].sort((a, b) => a.name.localeCompare(b.name, 'tr'));

            sortedDocs.forEach(doc => {

                let stats = { total: 0, weekday: 0, friday: 0, saturday: 0, sunday: 0 };

                let slotCounts = {}; 

                settings.slots.forEach(s => slotCounts[`slot${s.id}`] = 0);

                Object.keys(assignments).forEach(dateStr => {

                    const d = new Date(dateStr);

                    const day = d.getDay(); 

                    let worked = false;

                    settings.slots.forEach(s => {

                        const assignedDocs = assignments[dateStr][`slot${s.id}`] || [];

                        if(assignedDocs.includes(doc.name)) {

                            slotCounts[`slot${s.id}`]++;

                            worked = true;

                        }

                    });

                    if(worked) {

                        stats.total++;

                        if(day === 5) stats.friday++;

                        else if(day === 6) stats.saturday++;

                        else if(day === 0) stats.sunday++;

                        else stats.weekday++;

                    }

                });

                let row = [`"${doc.name}"`];

                settings.slots.forEach(s => row.push(slotCounts[`slot${s.id}`]));

                row.push(stats.total, stats.weekday, stats.friday, stats.saturday, stats.sunday);

                csvContent += row.join(";") + "\n";

            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");

            link.setAttribute("href", url);

            link.setAttribute("download", "MediNobet_Raporu.csv");

            document.body.appendChild(link);

            link.click();

            document.body.removeChild(link);

        }

        if ('serviceWorker' in navigator) {

            navigator.serviceWorker.register('sw.js')

                .then(reg => console.log('SW kayıt edildi:', reg.scope))

                .catch(err => console.log('SW kayıt hatası (Normal olabilir):', err));

        }
</script>
</body>
</html>
 
