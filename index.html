<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PediNöbet - Akıllı Takip</title>
    
    <!-- iOS (iPhone) İçin Özel PWA Ayarları -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PediNöbet">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">

    <style>
        body {
            font-family: 'Varela Round', sans-serif;
            background-color: #f0f9ff;
            -webkit-tap-highlight-color: transparent;
            /* iOS'ta kaydırma hissiyatını düzeltir */
            -webkit-overflow-scrolling: touch; 
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        input[type="date"] {
            appearance: none;
            -webkit-appearance: none;
        }
        .shift-card-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .warning-box {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col">

    <!-- Üst Başlık -->
    <header class="bg-blue-600 text-white p-4 shadow-lg z-10 sticky top-0 pt-safe-top">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-user-nurse text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold leading-tight">PediNöbet</h1>
                    <p class="text-xs text-blue-200 opacity-90">Generated by Uzm.Dr. Feride GÜL</p>
                </div>
            </div>
            <!-- Buton Grubu -->
            <div class="flex gap-2">
                <button onclick="downloadSummaryCSV()" class="text-xs bg-green-500 hover:bg-green-600 px-3 py-1.5 rounded text-white transition flex items-center shadow-md border border-green-600">
                    <i class="fa-solid fa-file-excel mr-1"></i> Rapor İndir
                </button>
                <button onclick="clearAllData()" class="text-xs bg-blue-700 hover:bg-blue-800 px-3 py-1.5 rounded transition shadow-md border border-blue-800">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Ana İçerik -->
    <main class="flex-1 overflow-y-auto p-4 pb-24 max-w-2xl mx-auto w-full">
        
        <!-- Nöbet Ekleme Formu -->
        <div class="glass-card rounded-2xl p-5 shadow-sm mb-6 border-l-4 border-blue-500">
            <h2 class="text-lg font-bold mb-4 text-blue-600 flex items-center">
                <i class="fa-solid fa-calendar-plus mr-2"></i> Yeni Nöbet Girişi
            </h2>
            
            <form id="shiftForm" class="space-y-4">
                <!-- Tarih Seçimi -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tarih</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400">
                            <i class="fa-regular fa-calendar"></i>
                        </div>
                        <input type="date" id="shiftDate" required onchange="validateDate()"
                            class="w-full pl-10 pr-3 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:bg-white transition shadow-sm">
                    </div>
                </div>

                <!-- KURALLAR / UYARI ALANI -->
                <div id="validationBox" class="hidden rounded-xl p-3 text-sm border warning-box">
                    <h4 class="font-bold mb-1 flex items-center gap-2" id="validationTitle">
                        <!-- JS ile dolacak -->
                    </h4>
                    <ul id="validationList" class="list-disc list-inside space-y-1 opacity-90 text-xs">
                        <!-- JS ile dolacak -->
                    </ul>
                </div>

                <!-- Doktor Adı -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Doktor Adı</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400">
                            <i class="fa-solid fa-user-doctor"></i>
                        </div>
                        <input type="text" id="doctorName" placeholder="Örn: Dr. Ali Yılmaz" required
                            class="w-full pl-10 pr-3 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:bg-white transition shadow-sm">
                    </div>
                </div>

                <!-- Nöbet Tipi (YENİLENMİŞ) -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nöbet Yeri</label>
                    <div class="grid grid-cols-2 gap-2">
                        <!-- Servis -->
                        <label class="cursor-pointer">
                            <input type="radio" name="shiftType" value="Servis" class="peer hidden" checked>
                            <div class="text-center py-2 rounded-lg border border-slate-200 bg-white text-slate-500 peer-checked:bg-green-100 peer-checked:text-green-700 peer-checked:border-green-300 transition hover:bg-slate-50">
                                <i class="fa-solid fa-bed-pulse mb-1 block text-lg"></i> Servis
                            </div>
                        </label>
                        <!-- Konsültasyon -->
                        <label class="cursor-pointer">
                            <input type="radio" name="shiftType" value="Konsültasyon" class="peer hidden">
                            <div class="text-center py-2 rounded-lg border border-slate-200 bg-white text-slate-500 peer-checked:bg-purple-100 peer-checked:text-purple-700 peer-checked:border-purple-300 transition hover:bg-slate-50">
                                <i class="fa-solid fa-user-md mb-1 block text-lg"></i> Konsültasyon
                            </div>
                        </label>
                        <!-- Acil 1 -->
                        <label class="cursor-pointer">
                            <input type="radio" name="shiftType" value="Acil 1" class="peer hidden">
                            <div class="text-center py-2 rounded-lg border border-slate-200 bg-white text-slate-500 peer-checked:bg-red-100 peer-checked:text-red-700 peer-checked:border-red-300 transition hover:bg-slate-50">
                                <i class="fa-solid fa-truck-medical mb-1 block text-lg"></i> Acil 1
                            </div>
                        </label>
                        <!-- Acil 2 -->
                        <label class="cursor-pointer">
                            <input type="radio" name="shiftType" value="Acil 2" class="peer hidden">
                            <div class="text-center py-2 rounded-lg border border-slate-200 bg-white text-slate-500 peer-checked:bg-red-50 peer-checked:text-red-600 peer-checked:border-red-200 transition hover:bg-slate-50">
                                <i class="fa-solid fa-truck-medical mb-1 block text-lg opacity-70"></i> Acil 2
                            </div>
                        </label>
                        <!-- Yedek 1 -->
                        <label class="cursor-pointer">
                            <input type="radio" name="shiftType" value="Yedek 1" class="peer hidden">
                            <div class="text-center py-2 rounded-lg border border-slate-200 bg-white text-slate-500 peer-checked:bg-gray-200 peer-checked:text-gray-700 peer-checked:border-gray-400 transition hover:bg-slate-50">
                                <i class="fa-solid fa-clipboard-user mb-1 block text-lg"></i> Yedek 1
                            </div>
                        </label>
                         <!-- Yedek 2 -->
                         <label class="cursor-pointer">
                            <input type="radio" name="shiftType" value="Yedek 2" class="peer hidden">
                            <div class="text-center py-2 rounded-lg border border-slate-200 bg-white text-slate-500 peer-checked:bg-gray-100 peer-checked:text-gray-600 peer-checked:border-gray-300 transition hover:bg-slate-50">
                                <i class="fa-solid fa-clipboard-user mb-1 block text-lg opacity-70"></i> Yedek 2
                            </div>
                        </label>
                    </div>
                </div>

                <button type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 active:transform active:scale-95 transition flex justify-center items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Nöbeti Kaydet
                </button>
            </form>
        </div>

        <!-- Filtreleme ve İstatistik -->
        <div class="flex justify-between items-center mb-3 px-1">
            <h3 class="text-slate-600 font-bold">Nöbet Listesi</h3>
            <span id="totalShifts" class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-xs font-bold">0 Nöbet</span>
        </div>

        <!-- Liste -->
        <ul id="shiftList" class="space-y-3"></ul>
        
        <!-- Boş Durum -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-10 text-slate-400">
            <i class="fa-solid fa-calendar-check text-4xl mb-3 opacity-50"></i>
            <p>Henüz nöbet girişi yok.</p>
        </div>

    </main>

    <script>
        // Global Değişkenler
        const shiftForm = document.getElementById('shiftForm');
        const shiftList = document.getElementById('shiftList');
        const emptyState = document.getElementById('emptyState');
        const totalShiftsBadge = document.getElementById('totalShifts');
        const validationBox = document.getElementById('validationBox');
        const validationTitle = document.getElementById('validationTitle');
        const validationList = document.getElementById('validationList');

        document.addEventListener('DOMContentLoaded', () => {
            loadShifts();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('shiftDate').value = today;
            validateDate();
        });

        // Form Gönderimi
        shiftForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const date = document.getElementById('shiftDate').value;
            let nameInput = document.getElementById('doctorName').value;
            const name = nameInput.replace(/\b\w/g, l => l.toUpperCase());
            const type = document.querySelector('input[name="shiftType"]:checked').value;

            if (!date || !name) return;

            const shift = { 
                id: Date.now(), 
                date: date, 
                name: name, 
                type: type 
            };

            saveShift(shift);
            renderShifts();
            validateDate();
            
            document.getElementById('doctorName').value = '';
            document.getElementById('doctorName').focus();
        });

        function saveShift(shift) {
            let shifts = JSON.parse(localStorage.getItem('pediShifts')) || [];
            shifts.push(shift);
            localStorage.setItem('pediShifts', JSON.stringify(shifts));
        }

        // --- KURALLAR (YENİ TİPLERE GÖRE) ---
        function validateDate() {
            const dateInput = document.getElementById('shiftDate').value;
            if (!dateInput) return;

            let shifts = JSON.parse(localStorage.getItem('pediShifts')) || [];
            const dailyShifts = shifts.filter(s => s.date === dateInput);

            // Yeni tiplere göre sayım
            const serviceCount = dailyShifts.filter(s => s.type === 'Servis').length;
            const acil1Count = dailyShifts.filter(s => s.type === 'Acil 1').length;
            const acil2Count = dailyShifts.filter(s => s.type === 'Acil 2').length;
            const consultCount = dailyShifts.filter(s => s.type === 'Konsültasyon').length;
            
            const totalActive = serviceCount + acil1Count + acil2Count + consultCount;

            const messages = [];
            let isError = false; 
            let isWarning = false;

            // Kurallar (Genel mantık)
            // Servis hala kritik olabilir
            if (serviceCount > 1) {
                messages.push(`Servis nöbetçisi birden fazla (${serviceCount}).`);
                isWarning = true;
            }
            if (serviceCount < 1) {
                messages.push(`Servis nöbetçisi yok.`);
                isWarning = true;
            }
            // Toplam kontrolü (Örnek kural)
            if (totalActive < 2) {
                messages.push(`Toplam nöbetçi sayısı çok az (${totalActive}).`);
                isWarning = true;
            }

            // Uyarı Kutusunu Göster/Gizle
            if (messages.length > 0) {
                validationBox.classList.remove('hidden');
                validationList.innerHTML = messages.map(m => `<li>${m}</li>`).join('');
                
                if (isError) {
                    validationBox.className = 'rounded-xl p-3 text-sm border warning-box bg-red-50 border-red-200 text-red-700 block mb-4';
                    validationTitle.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Kural İhlali`;
                } else {
                    validationBox.className = 'rounded-xl p-3 text-sm border warning-box bg-amber-50 border-amber-200 text-amber-700 block mb-4';
                    validationTitle.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> Eksiklik Var`;
                }
            } else {
                validationBox.classList.remove('hidden');
                validationBox.className = 'rounded-xl p-3 text-sm border warning-box bg-green-50 border-green-200 text-green-700 block mb-4';
                validationTitle.innerHTML = `<i class="fa-solid fa-check-circle"></i> Durum Özeti`;
                validationList.innerHTML = `<li>Servis: ${serviceCount}, Acil 1: ${acil1Count}, Acil 2: ${acil2Count}</li>`;
            }
        }

        // Listeleme
        function renderShifts() {
            let shifts = JSON.parse(localStorage.getItem('pediShifts')) || [];
            shifts.sort((a, b) => new Date(a.date) - new Date(b.date));

            const shiftCounter = {}; 
            const shiftsWithCounts = shifts.map(shift => {
                const date = new Date(shift.date);
                const key = `${shift.name}_${date.getFullYear()}-${date.getMonth()}`;
                if (!shiftCounter[key]) shiftCounter[key] = 0;
                shiftCounter[key]++;
                return { ...shift, monthlyCount: shiftCounter[key] };
            });
            
            shiftList.innerHTML = '';
            
            if (shiftsWithCounts.length === 0) {
                emptyState.classList.remove('hidden');
                totalShiftsBadge.textContent = '0 Nöbet';
                return;
            }

            emptyState.classList.add('hidden');
            totalShiftsBadge.textContent = `${shiftsWithCounts.length} Kayıt`;

            shiftsWithCounts.forEach(shift => {
                const li = document.createElement('li');
                li.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center shift-card-enter';
                
                const dateObj = new Date(shift.date);
                const day = dateObj.toLocaleDateString('tr-TR', { day: 'numeric' });
                const month = dateObj.toLocaleDateString('tr-TR', { month: 'short' });
                const weekday = dateObj.toLocaleDateString('tr-TR', { weekday: 'long' });

                // Renk Ayarları (Yeni tiplere göre)
                let typeColor = 'bg-blue-100 text-blue-600';
                let typeIcon = 'fa-bed-pulse';
                
                if(shift.type.includes('Acil')) { typeColor = 'bg-red-100 text-red-600'; typeIcon = 'fa-truck-medical'; }
                if(shift.type === 'Konsültasyon') { typeColor = 'bg-purple-100 text-purple-600'; typeIcon = 'fa-user-md'; }
                if(shift.type.includes('Yedek')) { typeColor = 'bg-gray-100 text-gray-600'; typeIcon = 'fa-clipboard-user'; }

                // --- SİLME BUTONU DÜZELTİLDİ ---
                // Fonksiyonu doğrudan sayı ile çağırıyoruz
                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col items-center justify-center bg-slate-100 rounded-lg p-2 min-w-[60px]">
                            <span class="text-xl font-bold text-slate-700 leading-none">${day}</span>
                            <span class="text-xs text-slate-500 uppercase">${month}</span>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="font-bold text-slate-800">${shift.name}</h4>
                                <span class="text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded font-bold">
                                    ${shift.monthlyCount}. Nöbet
                                </span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs px-2 py-0.5 rounded-md ${typeColor} font-medium flex items-center gap-1">
                                    <i class="fa-solid ${typeIcon} text-[10px]"></i> ${shift.type}
                                </span>
                                <span class="text-xs text-slate-400">${weekday}</span>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="deleteShift(${shift.id})" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-300 hover:bg-red-50 hover:text-red-500 transition z-10 active:bg-red-100 cursor-pointer">
                        <i class="fa-solid fa-trash-can text-lg"></i>
                    </button>
                `;
                shiftList.appendChild(li);
            });
        }

        function loadShifts() { renderShifts(); }

        // --- SİLME FONKSİYONU (Düzeltildi) ---
        // Global scope'a açık ve direkt ID alıyor
        window.deleteShift = function(id) {
            // ID'yi sayıya çevir
            const idNum = parseInt(id);
            
            if(confirm('Bu nöbeti silmek istediğinize emin misiniz?')) {
                let shifts = JSON.parse(localStorage.getItem('pediShifts')) || [];
                
                // Silinen nöbeti bul
                const deletedShift = shifts.find(s => s.id === idNum);
                
                // Filtrele
                shifts = shifts.filter(shift => shift.id !== idNum);
                
                localStorage.setItem('pediShifts', JSON.stringify(shifts));
                renderShifts();
                
                // Validasyon
                const currentDate = document.getElementById('shiftDate').value;
                if(deletedShift && deletedShift.date === currentDate) {
                    validateDate();
                }
            }
        }

        window.clearAllData = function() {
            if(confirm('DİKKAT: Tüm nöbet listesini silmek istediğinize emin misiniz?')) {
                localStorage.removeItem('pediShifts');
                renderShifts();
                validateDate();
            }
        }

        // --- CSV RAPOR FORMATI (Düzeltildi) ---
        // Türkçe Excel için Noktalı Virgül (;) kullanıldı
        // Sütunlar yeni tiplere göre güncellendi
        window.downloadSummaryCSV = function() {
            let shifts = JSON.parse(localStorage.getItem('pediShifts')) || [];
            if (shifts.length === 0) {
                alert("İndirilecek veri yok.");
                return;
            }

            const summary = {};

            shifts.forEach(shift => {
                const name = shift.name;
                if (!summary[name]) {
                    summary[name] = {
                        name: name,
                        servis: 0,
                        acil1: 0,
                        acil2: 0,
                        konsult: 0,
                        yedek1: 0,
                        yedek2: 0,
                        total: 0,
                        weekday: 0,
                        friday: 0,
                        saturday: 0,
                        sunday: 0
                    };
                }

                // Tipleri say
                if (shift.type === 'Servis') summary[name].servis++;
                else if (shift.type === 'Acil 1') summary[name].acil1++;
                else if (shift.type === 'Acil 2') summary[name].acil2++;
                else if (shift.type === 'Konsültasyon') summary[name].konsult++;
                else if (shift.type === 'Yedek 1') summary[name].yedek1++;
                else if (shift.type === 'Yedek 2') summary[name].yedek2++;
                
                summary[name].total++;

                // Günleri say
                const d = new Date(shift.date);
                const dayIndex = d.getDay(); 
                
                if (dayIndex === 5) summary[name].friday++;
                else if (dayIndex === 6) summary[name].saturday++;
                else if (dayIndex === 0) summary[name].sunday++;
                else summary[name].weekday++;
            });

            // Türkçe karakterler için BOM
            let csvContent = "\uFEFF"; 
            
            // 1. Satır: Boş (Excel şablonuna uygun)
            csvContent += ";;;;;;;;;;;\n";
            // 2. Satır: Başlıklar (YENİ TİPLERE GÖRE VE NOKTALI VİRGÜL İLE)
            csvContent += "İSİM;SERVİS;ACİL 1;ACİL 2;KONSÜLTASYON;YEDEK 1;YEDEK 2;TOPLAM;HAFTAİÇİ ;CUMA ;CUMARTESİ ;PAZAR\n";

            // Veriyi yazdır
            Object.values(summary).sort((a, b) => a.name.localeCompare(b.name)).forEach(doc => {
                const row = [
                    `"${doc.name}"`,
                    doc.servis,
                    doc.acil1,
                    doc.acil2,
                    doc.konsult,
                    doc.yedek1,
                    doc.yedek2,
                    doc.total,
                    doc.weekday,
                    doc.friday,
                    doc.saturday,
                    doc.sunday
                ].join(";");
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "Doktor_Nobet_Listesi.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Hatası', err));
        }
    </script>
</body>
</html>